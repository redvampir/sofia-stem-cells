# Органы для контроля ошибок: Нервная и Иммунная системы

Этот документ описывает два первых «органа» системы: Нервную систему (обнаружение ошибок и событий) и Иммунную систему (реакция на ошибки: изоляция или удаление артефактов). Цель — держать «организм» стабильным, не допуская распространения повреждений и регрессий.

## Роли и ответственность

### Нервная система
- **Наблюдение и сигнализация.** Подписывается на события и метрики: ошибки исполнения, валидационные сбои артефактов, необычные задержки.
- **Классификация.** Нормализует события до единого формата (код, источник, критичность, контекст артефакта/плагина).
- **Маршрутизация.** Передает события в Иммунную систему с предложением действия (изоляция, удаление, игнорирование) на основе политики.

### Иммунная система
- **Политики реакции.** Применяет правила: мягкая изоляция (отключение/feature-flag), карантин артефакта (не выдавать в прод), жесткое удаление (полное снятие артефакта), запрос ручного ревью.
- **Восстановление и откат.** Умеет переключать трафик на стабильные версии органа/артефакта, инициировать откат миграций.
- **Аудит.** Записывает журнал действий (кто/что/когда/почему), чтобы избежать «немых» удалений.

## Потоки данных (упрощенно)
1. Нервная система получает событие от валидации, теста или рантайма.
2. Событие нормализуется, обогащается метаданными (версия схемы, идентификатор органа, зависимости).
3. Иммунная система выбирает политику по матрице [критичность × доверие к источнику × стадия среды].
4. Применяются действия: изоляция/карантин/удаление/ручной эскалации.
5. Итог фиксируется в журнале и, при необходимости, пушится в мониторинг/оповещения.

## Сколько реализма и автоматизации
- **Скепсис:** без четких политик иммунитет станет «кибер-аутоиммункой», когда полезные органы будут удалены как «вредители». Нужны явные политики по типу инцидента и среде.
- **Границы автоматизации:** автоматическое удаление — только для низкого доверия (например, неизвестный автор + провал валидации). Высокая критичность → изоляция + ручное подтверждение.
- **Схема событий:** договориться о единой схеме, иначе комбинации «форма ошибки v1» + «иммунитет v2» приведут к пропускам или ложным срабатываниям.

## Минимальные требования к реализации
- Формат событий с полями: `id`, `timestamp`, `source`, `severity`, `artifactId`, `schemaVersion`, `message`, `stackTrace?`.
- Политики в явном конфиге (YAML/JSON), поддержка версионирования и тестов на конфиги.
- Изоляция как стратегия по умолчанию; удаление — только через подтвержденный чек-лист.
- Метрики: количество срабатываний, время реакции, доля ложных срабатываний (для калибровки иммунитета).

## Пример сценария
- **Событие:** Нервная система ловит провал проверки контрольной суммы у органа «сердце v3» в стадии pre-prod.
- **Решение:** Иммунная система применяет политику «критично + среда pre-prod + низкое доверие источника»: карантинит орган, не пускает в прод, открывает задачу на ревью.

## Риски и как их контролировать
- **Ложные срабатывания:** ввести квоты и пороги, логировать решения иммунитета и периодически пересматривать правила.
- **Старение политик:** тесты-конфигов должны падать при устаревших ключах/неподдерживаемых версиях схемы.
- **Наблюдаемость:** без журналов и метрик иммунитет становится «черным ящиком». Логи и дашборды обязательны.

## Дорожная карта (кратко)
1. Согласовать и зафиксировать схему событий и формат политик.
2. Реализовать Нервную систему как слой нормализации событий с unit-тестами на схемы.
3. Реализовать Иммунную систему с матрицей политик и режимом dry-run для раннего тестирования.
4. Подключить мониторинг и отчеты по эффективности иммунитета.

Комментарий циничного ассистента:
1. Без четких правил иммунитет начнет удалять всё подряд — особенно то, что работает.
2. Карантин лучше удаления: восстановить проще, чем объяснить, кто сломал прод.
3. Автоматизация хороша, пока не бьет по здоровым органам — держи палец на триггере ручного отката.
